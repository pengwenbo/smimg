<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

    <title></title>
    <style type="text/css">
        * {
            padding: 0;
            margin: 0;
        }

        .SM_wrap {
        }

            .SM_wrap > video {
                width: 100%;
                height: 736px;
            }
            .SM_wrap > canvas {
             width:100%;
            }
    </style>

</head>
<body>
    <div class="SM_wrap">
        <input type="button" id="btnsm" value="点你行不行" />
        <video id="video"></video>
        <canvas id="canvas"></canvas>
        <button id="startbutton">Take photo</button>
    </div>
  
    <div class="output">
        <img id="photo" style="   -webkit-filter: contrast(180%) brightness(150%) saturate(2) ; /* Chrome, Safari, Opera */
    filter: contrast(180%) brightness(150%) saturate(2) ;" alt="The screen capture will appear in this box.">
    </div>
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script>
        document.getElementById('btnsm').addEventListener('click', function (ev) {
            var exArray = []; //存储设备源ID
            MediaStreamTrack.getSources(function (sourceInfos) {
                for (var i = 0; i != sourceInfos.length; ++i) {
                    var sourceInfo = sourceInfos[i];
                    //这里会遍历audio,video，所以要加以区分
                    if (sourceInfo.kind === 'video') {
                        exArray.push(sourceInfo.id);
                    }
                }
            });

            var p = navigator.getUserMedia({
                audio: false,
                video: {
                    'optional': [{
                        'sourceId': exArray[1] //0为前置摄像头，1为后置
                    }]
                }
            });

            p.then(function (mediaStream) {
                var video = document.querySelector('video');
                
                streaming = mediaStream;
                video.srcObject = mediaStream;
                video.play();
                //video.src = window.URL.createObjectURL(mediaStream);
                //video.onloadedmetadata = function (e) {
                //    // Do something with the video here.

                //};
            });

            p.catch(function (err) { console.log(err.name); });

            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            photo = document.getElementById('photo');
            startbutton = document.getElementById('startbutton');
            var width = $(window).width();    // We will scale the photo width to this
            var height = 400;

            video.addEventListener('canplay', function (ev) {
                height = width * video.videoHeight / video.videoWidth;
                if (!streaming) {
                    height = video.videoHeight / (video.videoWidth / width);
                    console.log(video.videoWidth + "and" + video.videoHeight);
                    video.setAttribute('width', width);
                    video.setAttribute('height', height);
                    canvas.setAttribute('width', width);
                    canvas.setAttribute('height', height);
                    streaming = true;
                }
            }, false);

            startbutton.addEventListener('click', function (ev) {
                takepicture();
                ev.preventDefault();
            }, false);

            function takepicture() {
                var context = canvas.getContext('2d');
                if (width && height) {
                    canvas.width = width;
                    canvas.height = height;
                    context.drawImage(video, 0, 0, width, height);
                    canvas.toBlob(function (blob) {
                        var url = URL.createObjectURL(blob);
                        photo.setAttribute('src', url);
                        //newImg.onload = function () {
                        //    // no longer need to read the blob so it's revoked
                        //    URL.revokeObjectURL(url);
                        //};

                        //newImg.src = url;
                        //document.body.appendChild(newImg);
                    });

                    //var data = canvas.toDataURL('image/png');
                    //photo.setAttribute('src', data);
                } else {
                    //clearphoto();
                }
            }

        }, false);

    </script>
</body>

</html> 
